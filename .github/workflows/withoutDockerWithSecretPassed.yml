# Name of the GitHub Actions workflow
name: Cypress API Tests - WITHOUT DOCKER

# Events that trigger this workflow
on:
  # Run workflow on pushes to the master branch
  push:
    branches: [ master ]

  # Run workflow on pull requests
  pull_request:

jobs:
  # -------------------
  # BUILD JOB
  # -------------------
  build-job:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository code
      - name: Checkout repo
        uses: actions/checkout@v4

      # Setup Node.js and enable npm cache
      # This cache is shared across jobs in the same workflow
      - name: Setup Node.js (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # Install dependencies
      # If cache is hit, npm will reuse downloaded packages
      - name: Install dependencies
        run: npm ci

      # Optional: build step (keep if needed)
      # - name: Build project
      #   run: npm run build

  # -------------------
  # TEST JOB
  # -------------------
  api-int-secretPassed:
    runs-on: ubuntu-latest

    # Run only after build-job succeeds
    needs: build-job

    # Targeting the correct environment on github actions is necessary
    environment: CI CD Env

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Setup Node.js and reuse npm cache
      - name: Setup Node.js (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # Install dependencies (fast due to cache)
      - name: Install dependencies
        run: npm ci

      # Run Cypress tests for api-int-secretPassed - Secret is passed in env, we just map here
      - name: Run Cypress tests (api-int-secretPassed)
        run: npx cypress run --spec "cypress/e2e/api-int-secretPassed/*.cy.{js,ts}"
          # If stored in Secrets, use
          # CYPRESS_API_BASE_URL: ${{ secrets.API_BASE_URL }}

          # if stored in variables, use
        env:
          CYPRESS_API_BASE_URL: ${{ vars.CYPRESS_API_BASE_URL }}
